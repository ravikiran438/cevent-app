/*
 * Copyright 2013 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * Atmosphere.js
 * https://github.com/Atmosphere/atmosphere-javascript
 * 
 * Requires 
 * - jQuery 2.0.3 http://jquery.com/
 * 
 * API reference
 * https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API
 * 
 * Highly inspired by 
 * - Portal by Donghwan Kim http://flowersinthesand.github.io/portal/
 */
(function(d){"function"===typeof define&&define.amd?define(["jquery"],d):d(jQuery)})(function(d){d(window).bind("unload.atmosphere",function(){d.atmosphere.unsubscribe()});d(window).bind("offline",function(){d.atmosphere.unsubscribe()});d(window).keypress(function(d){27===d.keyCode&&d.preventDefault()});var da=function(d){for(var k,g=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,t={};k=g.exec(d);)t[k[1]]=k[2];return t};d.atmosphere={version:"2.1.4-jquery",uuid:0,requests:[],callbacks:[],onError:function(d){},onClose:function(d){},
onOpen:function(d){},onMessage:function(d){},onReconnect:function(d,k){},onMessagePublished:function(d){},onTransportFailure:function(d,k){},onLocalMessage:function(d){},onClientTimeout:function(d){},onFailureToReconnect:function(d,k){},AtmosphereRequest:function(h){function k(b){p();Z=!0;I=!1;A=0;C=K=x=n=null;c=d.extend(c,b);c.mrequest=c.reconnect;c.reconnect||(c.reconnect=!0)}function g(){if(c.shared){u=t(c);if(null!=u&&("debug"===c.logLevel&&d.atmosphere.debug("Storage service available. All communication will be local"),
u.open(c)))return;"debug"===c.logLevel&&d.atmosphere.debug("No Storage service available.");u=null}c.firstMessage=0==d.atmosphere.uuid?!0:!1;c.isOpen=!1;c.ctime=d.now();0===c.uuid&&(c.uuid=d.atmosphere.uuid);c.closedByClientTimeout=!1;"websocket"!==c.transport&&"sse"!==c.transport?S(c):"websocket"===c.transport?null!=c.webSocketImpl||window.WebSocket||window.MozWebSocket?m(!1):L("Websocket is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"):"sse"===c.transport&&(window.EventSource?
q(!1):L("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"))}function t(b){function a(a){a=d.parseJSON(a);var f=a.data;if("c"===a.target)switch(a.type){case "open":l("opening","local",c);break;case "close":$||($=!0,"aborted"===f.reason?T():f.heir===F?g():setTimeout(function(){g()},100));break;case "message":G(f,"messageReceived",200,b.transport);break;case "localMessage":ea(f)}}function e(){var a=RegExp("(?:^|; )("+encodeURIComponent(v)+")=([^;]*)").exec(document.cookie);
if(a)return d.parseJSON(decodeURIComponent(a[2]))}var f,B,$,v="atmosphere-"+b.url,h={storage:function(){if(d.atmosphere.supportStorage()){var c=window.localStorage,f=function(a){return d.parseJSON(c.getItem(v+"-"+a))},e=function(a,b){c.setItem(v+"-"+a,d.stringifyJSON(b))};return{init:function(){e("children",f("children").concat([F]));d(window).on("storage.socket",function(b){b=b.originalEvent;b.key===v&&b.newValue&&a(b.newValue)});return f("opened")},signal:function(a,b){c.setItem(v,d.stringifyJSON({target:"p",
type:a,data:b}))},close:function(){var a,c=f("children");d(window).off("storage.socket");c&&(a=d.inArray(b.id,c),-1<a&&(c.splice(a,1),e("children",c)))}}}},windowref:function(){var b=window.open("",v.replace(/\W/g,""));if(b&&!b.closed&&b.callbacks)return{init:function(){b.callbacks.push(a);b.children.push(F);return b.opened},signal:function(a,c){!b.closed&&b.fire&&b.fire(d.stringifyJSON({target:"p",type:a,data:c}))},close:function(){if(!$){var c=b.callbacks,f=d.inArray(a,c);-1<f&&c.splice(f,1);c=
b.children;f=d.inArray(F,c);-1<f&&c.splice(f,1)}}}}};if((f=e())&&!(1E3<d.now()-f.ts)&&(B=h.storage()||h.windowref()))return{open:function(){var c;U=setInterval(function(){var b=f;(f=e())&&b.ts!==f.ts||a(d.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:b.heir}}))},1E3);(c=B.init())&&setTimeout(function(){l("opening","local",b)},50);return c},send:function(a){B.signal("send",a)},localSend:function(a){B.signal("localSend",d.stringifyJSON({id:F,event:a}))},close:function(){I||(clearInterval(U),
B.signal("close"),B.close())}}}function O(){function b(a){a=d.parseJSON(a);var b=a.data;if("p"===a.target)switch(a.type){case "send":aa(b);break;case "localSend":ea(b);break;case "close":T()}}function a(){document.cookie=ba+"="+encodeURIComponent(d.stringifyJSON({ts:d.now()+1,heir:(e.get("children")||[])[0]}))+"; path=/"}var e,f="atmosphere-"+c.url,B={storage:function(){if(d.atmosphere.supportStorage()){var a=window.localStorage;return{init:function(){d(window).on("storage.socket",function(a){a=a.originalEvent;
a.key===f&&a.newValue&&b(a.newValue)})},signal:function(b,c){a.setItem(f,d.stringifyJSON({target:"c",type:b,data:c}))},get:function(b){return d.parseJSON(a.getItem(f+"-"+b))},set:function(b,c){a.setItem(f+"-"+b,d.stringifyJSON(c))},close:function(){d(window).off("storage.socket");a.removeItem(f);a.removeItem(f+"-opened");a.removeItem(f+"-children")}}}},windowref:function(){var a=f.replace(/\W/g,""),c=(d('iframe[name="'+a+'"]')[0]||d('<iframe name="'+a+'" />').hide().appendTo("body")[0]).contentWindow;
return{init:function(){c.callbacks=[b];c.fire=function(a){var b;for(b=0;b<c.callbacks.length;b++)c.callbacks[b](a)}},signal:function(a,b){!c.closed&&c.fire&&c.fire(d.stringifyJSON({target:"c",type:a,data:b}))},get:function(a){return c.closed?null:c[a]},set:function(a,b){c.closed||(c[a]=b)},close:function(){}}}};P=function(a){e.signal("message",a)};e=B.storage()||B.windowref();e.init();"debug"===c.logLevel&&d.atmosphere.debug("Installed StorageService "+e);e.set("children",[]);null==e.get("opened")||
e.get("opened")||e.set("opened",!1);ba=encodeURIComponent(f);a();U=setInterval(a,1E3);D=e}function l(b,a,d){c.shared&&"local"!==a&&O();null!=D&&D.set("opened",!0);d.close=function(){T()};0<A&&"re-connecting"===b?(d.isReopen=!0,na(e)):null==e.error&&(e.request=d,d=e.state,e.state=b,b=e.transport,e.transport=a,a=e.responseBody,w(),e.responseBody=a,e.state=d,e.transport=b)}function fa(b){b.transport="jsonp";var a=c;null!=b&&"undefined"!==typeof b&&(a=b);b=a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);
var y=a.data;a.attachHeadersAsQueryString&&(b=J(a),""!==y&&(b+="&X-Atmosphere-Post-Body="+encodeURIComponent(y)),y="");r=d.ajax({url:b,type:a.method,dataType:"jsonp",error:function(b,c,d){e.error=!0;a.openId&&clearTimeout(a.openId);a.reconnect&&A++<a.maxReconnectOnClose?(l("re-connecting",a.transport,a),z(r,a,a.reconnectInterval),a.openId=setTimeout(function(){V(a)},a.reconnectInterval+1E3)):s(b.status,d)},jsonp:"jsonpTransport",success:function(b){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<
a.maxRequest){W(r,a);a.executeCallbackBeforeReconnect||z(r,a,0);b=b.message;if(null!=b&&"string"!==typeof b)try{b=d.stringifyJSON(b)}catch(y){}E(b,a,e)||G(e.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&z(r,a,0)}else d.atmosphere.log(c.logLevel,["JSONP reconnect maximum try reached "+c.requestCount]),s(0,"maxRequest reached")},data:a.data,beforeSend:function(b){ca(b,a,!1)}})}function oa(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);b=a.url;null!=a.dispatchUrl&&
(b+=a.dispatchUrl);var y=a.data;a.attachHeadersAsQueryString&&(b=J(a),""!==y&&(b+="&X-Atmosphere-Post-Body="+encodeURIComponent(y)),y="");r=d.ajax({url:b,type:a.method,error:function(b,c,d){e.error=!0;300>b.status?z(r,a):s(b.status,d)},success:function(b,y,g){a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest?(a.executeCallbackBeforeReconnect||z(r,a,0),E(b,a,e)||G(e.responseBody,"messageReceived",200,a.transport),a.executeCallbackBeforeReconnect&&z(r,a,0)):(d.atmosphere.log(c.logLevel,
["AJAX reconnect maximum try reached "+c.requestCount]),s(0,"maxRequest reached")))},beforeSend:function(b){ca(b,a,!1)},crossDomain:a.enableXDR,async:"undefined"!==typeof a.async?a.async:!0})}function pa(b){return null!=c.webSocketImpl?c.webSocketImpl:window.WebSocket?new WebSocket(b):new MozWebSocket(b)}function M(){var b=J(c);return decodeURI(d('<a href="'+b+'"/>')[0].href.replace(/^http/,"ws"))}function q(b){e.transport="sse";var a=J(c);"debug"===c.logLevel&&(d.atmosphere.debug("Invoking executeSSE"),
d.atmosphere.debug("Using URL: "+a));if(c.enableProtocol&&b){var y=d.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(y)}if(b&&!c.reconnect)null!=x&&p();else{try{x=new EventSource(a,{withCredentials:c.withCredentials})}catch(f){s(0,f);L("SSE failed. Downgrading to fallback transport and resending");return}0<c.connectTimeout&&(c.id=setTimeout(function(){b||p()},c.connectTimeout));x.onopen=function(a){H(c);"debug"===c.logLevel&&d.atmosphere.debug("SSE successfully opened");c.enableProtocol?c.isReopen&&
(c.isReopen=!1,l("re-opening",c.transport,c)):b?l("re-opening","sse",c):l("opening","sse",c);b=!0;"POST"===c.method&&(e.state="messageReceived",x.send(c.data))};x.onmessage=function(a){H(c);c.enableXDR||a.origin===window.location.protocol+"//"+window.location.host?(e.state="messageReceived",e.status=200,a=a.data,E(a,c,e)||(w(),e.responseBody="",e.messages=[])):d.atmosphere.log(c.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host])};x.onerror=function(a){clearTimeout(c.id);
e.closedByClientTimeout||((N(b),p(),I)?d.atmosphere.log(c.logLevel,["SSE closed normally"]):b?c.reconnect&&"sse"===e.transport&&(A++<c.maxReconnectOnClose?(l("re-connecting",c.transport,c),0<c.reconnectInterval?c.reconnectId=setTimeout(function(){q(!0)},c.reconnectInterval):q(!0),e.responseBody="",e.messages=[]):(d.atmosphere.log(c.logLevel,["SSE reconnect maximum try reached "+A]),s(0,"maxReconnectOnClose reached"))):L("SSE failed. Downgrading to fallback transport and resending"))}}}function m(b){e.transport=
"websocket";if(c.enableProtocol&&b){var a=d.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(a)}a=M(c.url);"debug"===c.logLevel&&(d.atmosphere.debug("Invoking executeWebSocket"),d.atmosphere.debug("Using URL: "+a));if(b&&!c.reconnect)null!=n&&p();else if(n=pa(a),null!=c.webSocketBinaryType&&(n.binaryType=c.webSocketBinaryType),0<c.connectTimeout&&(c.id=setTimeout(function(){if(!b){n.onclose({code:1002,reason:"",wasClean:!1});try{p()}catch(a){}}},c.connectTimeout)),n.onopen=function(a){H(c);"debug"===
c.logLevel&&d.atmosphere.debug("Websocket successfully opened");a=b;b=!0;null!=n&&(n.webSocketOpened=b);c.enableProtocol||(a?l("re-opening","websocket",c):l("opening","websocket",c));null!=n&&"POST"===c.method&&(e.state="messageReceived",n.send(c.data))},n.onmessage=function(a){H(c);e.state="messageReceived";e.status=200;a=a.data;"string"===typeof a?E(a,c,e)||(w(),e.responseBody="",e.messages=[]):ga(c,a)&&(e.responseBody=a,w(),e.responseBody=null)},n.onerror=function(a){clearTimeout(c.id)},n.onclose=
function(a){if("closed"!==e.state){clearTimeout(c.id);var f=a.reason;if(""===f)switch(a.code){case 1E3:f="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:f="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:f="The endpoint is terminating the connection due to a protocol error.";break;case 1003:f="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";
break;case 1004:f="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:f="Unknown: no status code was provided even though one was expected.";break;case 1006:f="Connection was closed abnormally (that is, with no close frame being sent)."}"warn"===c.logLevel&&(d.atmosphere.warn("Websocket closed, reason: "+f),d.atmosphere.warn("Websocket closed, wasClean: "+a.wasClean));e.closedByClientTimeout||((N(b),e.state="closed",I)?d.atmosphere.log(c.logLevel,
["Websocket closed normally"]):b?c.reconnect&&"websocket"===e.transport&&(p(),A++<c.maxReconnectOnClose?(l("re-connecting",c.transport,c),0<c.reconnectInterval?c.reconnectId=setTimeout(function(){e.responseBody="";e.messages=[];m(!0)},c.reconnectInterval):(e.responseBody="",e.messages=[],m(!0))):(d.atmosphere.log(c.logLevel,["Websocket reconnect maximum try reached "+c.requestCount]),"warn"===c.logLevel&&d.atmosphere.warn("Websocket error, reason: "+a.reason),s(0,"maxReconnectOnClose reached"))):
L("Websocket failed. Downgrading to Comet and resending"))}},void 0===n.url)n.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function ga(b,a){var c=!0;if("polling"===b.transport)return c;if(0!==d.trim(a).length&&b.enableProtocol&&b.firstMessage){b.firstMessage=!1;var c=a.split(b.messageDelimiter),e=2===c.length?0:1;b.uuid=d.trim(c[e]);b.stime=d.trim(c[e+1]);c=!1;"long-polling"!==b.transport&&V(b);d.atmosphere.uuid=b.uuid}else b.enableProtocol&&b.firstMessage?c=!1:V(b);return c}
function H(b){clearTimeout(b.id);0<b.timeout&&"polling"!==b.transport&&(b.id=setTimeout(function(){e.closedByClientTimeout=!0;e.state="closedByClient";e.responseBody="";e.status=408;e.messages=[];w();X();p()},b.timeout))}function s(b,a){p();clearTimeout(c.id);e.state="error";e.reasonPhrase=a;e.responseBody="";e.status=b;e.messages=[];w()}function E(b,a,c){if(!ga(a,b)||0===b.length)return!0;if(a.trackMessageLength){b=c.partialMessage+b;for(var e=[],g=b.indexOf(a.messageDelimiter);-1!==g;){var h=d.trim(b.substring(0,
g)),k=parseInt(h,10);if(isNaN(k))throw'message length "'+h+'" is not a number';g+=a.messageDelimiter.length;g+k>b.length?g=-1:(e.push(b.substring(g,g+k)),b=b.substring(g+k,b.length),g=b.indexOf(a.messageDelimiter))}c.partialMessage=b;if(0!==e.length)c.responseBody=e.join(a.messageDelimiter),c.messages=e;else return c.responseBody="",c.messages=[],!0}else c.responseBody=b;return!1}function L(b){d.atmosphere.log(c.logLevel,[b]);if("undefined"!==typeof c.onTransportFailure)c.onTransportFailure(b,c);
else if("undefined"!==typeof d.atmosphere.onTransportFailure)d.atmosphere.onTransportFailure(b,c);c.transport=c.fallbackTransport;b=-1===c.connectTimeout?0:c.connectTimeout;c.reconnect&&"none"!==c.transport||null==c.transport?(c.method=c.fallbackMethod,e.transport=c.fallbackTransport,c.fallbackTransport="none",0<b?c.reconnectId=setTimeout(function(){g()},b):g()):s(500,"Unable to reconnect with fallback transport")}function J(b,a){var g=c;null!=b&&"undefined"!==typeof b&&(g=b);null==a&&(a=g.url);if(!g.attachHeadersAsQueryString||
-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+g.uuid;a+="&X-Atmosphere-Framework="+d.atmosphere.version;a+="&X-Atmosphere-Transport="+g.transport;g.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");a=null!=g.lastTimestamp?a+("&X-Cache-Date="+g.lastTimestamp):a+"&X-Cache-Date=0";""!==g.contentType&&(a+="&Content-Type="+("websocket"===g.transport?g.contentType:encodeURIComponent(g.contentType)));g.enableProtocol&&(a+="&X-atmo-protocol=true");
d.each(g.headers,function(c,h){var k=d.isFunction(h)?h.call(this,g,b,e):h;null!=k&&(a+="&"+encodeURIComponent(c)+"="+encodeURIComponent(k))});return a}function V(b){b.isOpen?b.isReopen&&(b.isReopen=!1,l("re-opening",b.transport,b)):(b.isOpen=!0,l("opening",b.transport,b))}function S(b){var a=c;if(null!=b||"undefined"!==typeof b)a=b;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport||a.enableXDR&&d.atmosphere.checkCORSSupport())fa(a);else if("ajax"===a.transport)oa(b);else{if(d.browser.msie&&10>
+d.browser.version.split(".")[0]){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?Q(a):R(a);return}if(a.enableXDR&&window.XDomainRequest){Q(a);return}}var g=function(){a.lastIndex=0;a.reconnect&&A++<a.maxReconnectOnClose?(l("re-connecting",b.transport,b),z(f,a,b.reconnectInterval)):s(0,"maxReconnectOnClose reached")};if(a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)){var f=d.ajaxSettings.xhr();f.hasData=!1;ca(f,a,!0);a.suspend&&(K=f);"polling"!==a.transport&&(e.transport=
a.transport,f.onabort=function(){N(!0)},f.onerror=function(){e.error=!0;try{e.status=XMLHttpRequest.status}catch(a){e.status=500}e.status||(e.status=500);e.errorHandled||(p(),g())});f.onreadystatechange=function(){if(!I){e.error=null;var h=!1,k=!1;if("streaming"===a.transport&&2<a.readyState&&4===f.readyState)a.reconnectingOnLength||(p(),g());else{a.readyState=f.readyState;"streaming"===a.transport&&3<=f.readyState?k=!0:"long-polling"===a.transport&&4===f.readyState&&(k=!0);H(c);if("polling"!==a.transport){var v=
200;4===f.readyState&&(v=1E3<f.status?0:f.status);if(300<=v||0===v){e.errorHandled=!0;p();g();return}a.enableProtocol&&b.firstMessage||2!==f.readyState||V(a)}else 4===f.readyState&&(k=!0);if(k)if(k=f.responseText,0===d.trim(k).length&&"long-polling"===a.transport)f.hasData?f.hasData=!1:z(f,a,0);else{f.hasData=!0;W(f,c);if("streaming"===a.transport)if(d.browser.opera)d.atmosphere.iterate(function(){if(500!==e.status&&f.responseText.length>a.lastIndex){try{e.status=f.status,e.headers=da(f.getAllResponseHeaders()),
W(f,c)}catch(b){e.status=404}H(c);e.state="messageReceived";var d=f.responseText.substring(a.lastIndex);a.lastIndex=f.responseText.length;(h=E(d,a,e))||w();ha(f,a)}else if(400<e.status)return a.lastIndex=f.responseText.length,!1},0);else{if(v=k.substring(a.lastIndex,k.length),h=E(v,a,e),a.lastIndex=k.length,h)return}else h=E(k,a,e);try{e.status=f.status,e.headers=da(f.getAllResponseHeaders()),W(f,a)}catch(m){e.status=404}e.state=a.suspend?0===e.status?"closed":"messageReceived":"messagePublished";
(k="streaming"!==b.transport&&"polling"!==b.transport)&&!a.executeCallbackBeforeReconnect&&z(f,a,0);0===e.responseBody.length||h||w();k&&a.executeCallbackBeforeReconnect&&z(f,a,0);ha(f,a)}}}};f.send(a.data);Z=!0}else"debug"===a.logLevel&&d.atmosphere.log(a.logLevel,["Max re-connection reached."]),s(0,"maxRequest reached")}}function ca(b,a,g){var f=a.url;null!=a.dispatchUrl&&"POST"===a.method&&(f+=a.dispatchUrl);f=J(a,f);f=d.atmosphere.prepareURL(f);g&&(b.open(a.method,f,!0),0<a.connectTimeout&&(a.id=
setTimeout(function(){0===a.requestCount&&(p(),G("Connect timeout","closed",200,a.transport))},a.connectTimeout)));c.withCredentials&&"withCredentials"in b&&(b.withCredentials=!0);c.dropHeaders||(b.setRequestHeader("X-Atmosphere-Framework",d.atmosphere.version),b.setRequestHeader("X-Atmosphere-Transport",a.transport),null!=a.lastTimestamp?b.setRequestHeader("X-Cache-Date",a.lastTimestamp):b.setRequestHeader("X-Cache-Date",0),a.trackMessageLength&&b.setRequestHeader("X-Atmosphere-TrackMessageSize",
"true"),b.setRequestHeader("X-Atmosphere-tracking-id",a.uuid),d.each(a.headers,function(c,f){var h=d.isFunction(f)?f.call(this,b,a,g,e):f;null!=h&&b.setRequestHeader(c,h)}));""!==a.contentType&&b.setRequestHeader("Content-Type",a.contentType)}function z(b,a,d){if(a.reconnect||a.suspend&&Z){var f=0;1<b.readyState&&(f=1E3<b.status?0:b.status);e.status=0===f?204:f;e.reason=0===f?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.reconnectId&&(clearTimeout(a.reconnectId),delete a.reconnectId);
0<d?setTimeout(function(){c.reconnectId=S(a)},d):S(a)}}function na(b){b.state="re-connecting";ia(b)}function Q(b){"polling"!==b.transport?(C=ja(b),C.open()):ja(b).open()}function ja(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var g=a.transport,f=0,h=new window.XDomainRequest,k=function(){"long-polling"===a.transport&&a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)&&(h.status=200,Q(a))},m=a.rewriteURL||function(a){var b=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);
switch(b&&b[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b[2]+"&").replace(/&$/,"")}return a};h.onprogress=function(){clearTimeout(a.id);var b=h.responseText,b=b.substring(f);f+=b.length;if("polling"!==g){H(a);var c=E(b,a,e);if("long-polling"!==g||0!==d.trim(b).length)a.executeCallbackBeforeReconnect&&k(),c||G(e.responseBody,"messageReceived",200,g),a.executeCallbackBeforeReconnect||
k()}};h.onerror=function(){"polling"!==a.transport&&(p(),A++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){l("re-connecting",b.transport,b);Q(a)},a.reconnectInterval):(l("re-connecting",b.transport,b),Q(a)):s(0,"maxReconnectOnClose reached"))};h.onload=function(){};return{open:function(){var b=a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);b=J(a,b);h.open(a.method,m(b));"GET"===a.method?h.send():h.send(a.data);0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&
(p(),G("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){h.abort()}}}function R(b){C=qa(b);C.open()}function qa(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var g,f=new window.ActiveXObject("htmlfile");f.open();f.close();var h=a.url;null!=a.dispatchUrl&&(h+=a.dispatchUrl);"polling"!==a.transport&&(e.transport=a.transport);return{open:function(){var b=f.createElement("iframe");h=J(a);""!==a.data&&(h+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));h=d.atmosphere.prepareURL(h);
b.src=h;f.body.appendChild(b);var k=b.contentDocument||b.contentWindow.document;g=d.atmosphere.iterate(function(){try{if(k.firstChild){if("complete"===k.readyState)try{d.noop(k.fileSize)}catch(b){return G("Connection Failure","error",500,a.transport),!1}var h=k.body?k.body.lastChild:k,m=function(){var a=h.cloneNode(!0);a.appendChild(k.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!d.nodeName(h,"pre")){var n=k.head||k.getElementsByTagName("head")[0]||k.documentElement||
k,p=k.createElement("script");p.text="document.write('<plaintext>')";n.insertBefore(p,n.firstChild);n.removeChild(p);h=k.body.lastChild}a.closed&&(a.isReopen=!0);g=d.atmosphere.iterate(function(){var b=m();if(b.length>a.lastIndex){H(c);e.status=200;e.error=null;h.innerText="";if(E(b,a,e))return"";G(e.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===k.readyState)return N(!0),l("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){R(a)},
a.reconnectInterval):R(a),!1},null);return!1}}catch(B){return e.error=!0,l("re-connecting",a.transport,a),A++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){R(a)},a.reconnectInterval):R(a):s(0,"maxReconnectOnClose reached"),f.execCommand("Stop"),f.close(),!1}})},close:function(){g&&g();f.execCommand("Stop");N(!0)}}}function aa(b){null!=u?u.send(b):null!=K||null!=x?Y(b):null!=C?c.enableXDR&&d.atmosphere.checkCORSSupport()?(b=ka(b),b.reconnect=!1,fa(b)):Y(b):null!=r?
Y(b):null!=n?ra(b):(s(0,"No suspended connection available"),d.atmosphere.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking this method"))}function Y(b){b=ka(b);S(b)}function la(b){var a=b;"object"===typeof a&&(a=b.data);return a}function ka(b){var a=la(b),a={connected:!1,timeout:6E4,method:"POST",url:c.url,contentType:c.contentType,headers:c.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",
requestCount:0,withCredentials:c.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:c.enableXDR,uuid:c.uuid,dispatchUrl:c.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",maxReconnectOnClose:c.maxReconnectOnClose};"object"===typeof b&&(a=d.extend(a,b));return a}function ra(b){var a=d.atmosphere.isBinary(b)?b:la(b),e;try{e=null!=c.dispatchUrl?c.webSocketPathDelimiter+c.dispatchUrl+c.webSocketPathDelimiter+a:a,n.webSocketOpened?n.send(e):d.atmosphere.error("WebSocket not connected.")}catch(f){n.onclose=
function(a){},p(),L("Websocket failed. Downgrading to Comet and resending "+e),Y(b)}}function ea(b){b=d.parseJSON(b);if(b.id!==F)if("undefined"!==typeof c.onLocalMessage)c.onLocalMessage(b.event);else if("undefined"!==typeof d.atmosphere.onLocalMessage)d.atmosphere.onLocalMessage(b.event)}function G(b,a,c,d){e.responseBody=b;e.transport=d;e.status=c;e.state=a;w()}function W(b,a){if(a.readResponsesHeaders)try{var c=b.getResponseHeader("X-Cache-Date");c&&null!=c&&0<c.length&&(a.lastTimestamp=c.split(" ").pop());
var e=b.getResponseHeader("X-Atmosphere-tracking-id");e&&null!=e&&(a.uuid=e.split(" ").pop())}catch(g){}else a.enableProtocol||(a.lastTimestamp=d.now(),a.uuid=d.atmosphere.guid())}function ia(b){ma(b,c);ma(b,d.atmosphere)}function ma(b,a){switch(b.state){case "messageReceived":A=0;if("undefined"!==typeof a.onMessage)a.onMessage(b);break;case "error":if("undefined"!==typeof a.onError)a.onError(b);break;case "opening":delete c.closed;if("undefined"!==typeof a.onOpen)a.onOpen(b);break;case "messagePublished":if("undefined"!==
typeof a.onMessagePublished)a.onMessagePublished(b);break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(c,b);break;case "closedByClient":if("undefined"!==typeof a.onClientTimeout)a.onClientTimeout(c);break;case "re-opening":delete c.closed;if("undefined"!==typeof a.onReopen)a.onReopen(c,b);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(c,b);break;case "unsubscribe":case "closed":var d="undefined"!==typeof c.closed?c.closed:
!1;if("undefined"!==typeof a.onClose&&!d)a.onClose(b);c.closed=!0}}function N(b){"closed"!==e.state&&(e.state="closed",e.responseBody="",e.messages=[],e.status=b?200:501,w())}function w(){var b=function(a,b){b(e)};null==u&&null!=P&&P(e.responseBody);c.reconnect=c.mrequest;for(var a="string"===typeof e.responseBody,g=a&&c.trackMessageLength?0<e.messages.length?e.messages:[""]:Array(e.responseBody),f=0;f<g.length;f++)if(!(1<g.length&&0===g[f].length)&&(e.responseBody=a?d.trim(g[f]):g[f],null==u&&null!=
P&&P(e.responseBody),0!==e.responseBody.length||"messageReceived"!==e.state)){ia(e);if(0<d.atmosphere.callbacks.length){"debug"===c.logLevel&&d.atmosphere.debug("Invoking "+d.atmosphere.callbacks.length+" global callbacks: "+e.state);try{d.each(d.atmosphere.callbacks,b)}catch(h){d.atmosphere.log(c.logLevel,["Callback exception"+h])}}if("function"===typeof c.callback){"debug"===c.logLevel&&d.atmosphere.debug("Invoking request callbacks");try{c.callback(e)}catch(k){d.atmosphere.log(c.logLevel,["Callback exception"+
k])}}}}function ha(b,a){""===e.partialMessage&&"streaming"===a.transport&&b.responseText.length>a.maxStreamingLength&&(e.messages=[],a.reconnectingOnLength=!0,N(!0),X(),p(),z(b,a,0))}function X(){if(c.enableProtocol&&!c.firstMessage){var b="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+c.uuid;d.each(c.headers,function(a,f){var g=d.isFunction(f)?f.call(this,c,c,e):f;null!=g&&(b+="&"+encodeURIComponent(a)+"="+encodeURIComponent(g))});var a=c.url.replace(/([?&])_=[^&]*/,b),a=a+(a===c.url?(/\?/.test(c.url)?
"&":"?")+b:"");0<c.connectTimeout?d.ajax({url:a,async:!1,timeout:c.connectTimeout,cache:!1}):d.ajax({url:a,async:!1,cache:!1})}}function T(){c.reconnectId&&(clearTimeout(c.reconnectId),delete c.reconnectId);c.reconnect=!1;I=!0;e.request=c;e.state="unsubscribe";e.responseBody="";e.status=408;w();X();p()}function p(){c.id&&clearTimeout(c.id);null!=C&&(C.close(),C=null);null!=r&&(r.abort(),r=null);null!=K&&(K.abort(),K=null);null!=n&&(n.webSocketOpened&&n.close(),n=null);null!=x&&(x.close(),x=null);
null!=D&&(clearInterval(U),document.cookie=ba+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",D.signal("close",{reason:"",heir:I?(D.get("children")||[])[0]:F}),D.close());null!=u&&u.close()}var c={timeout:3E5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,
dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,onError:function(b){},onClose:function(b){},onOpen:function(b){},onMessage:function(b){},onReopen:function(b,a){},onReconnect:function(b,a){},
onMessagePublished:function(b){},onTransportFailure:function(b,a){},onLocalMessage:function(b){},onFailureToReconnect:function(b,a){},onClientTimeout:function(b){}},e={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1},n=null,x=null,K=null,C=null,r=null,Z=!0,A=0,I=!1,P=null,D,u=null,F=d.now(),U,ba;k(h);this.subscribe=function(b){k(b);g()};this.execute=function(){g()};
this.invokeCallback=function(){w()};this.close=function(){T()};this.disconnect=function(){X()};this.getUrl=function(){return c.url};this.push=function(b,a){if(null!=a){var d=c.dispatchUrl;c.dispatchUrl=a;aa(b);c.dispatchUrl=d}else aa(b)};this.getUUID=function(){return c.uuid};this.pushLocal=function(b){if(0!==b.length)try{u?u.localSend(b):D&&D.signal("localMessage",d.stringifyJSON({id:F,event:b}))}catch(a){d.atmosphere.error(a)}};this.enableProtocol=function(b){return c.enableProtocol};this.request=
c;this.response=e},subscribe:function(h,k,g){"function"===typeof k&&d.atmosphere.addCallback(k);d.atmosphere.uuid=0;"string"!==typeof h?g=h:g.url=h;h=new d.atmosphere.AtmosphereRequest(g);h.execute();return d.atmosphere.requests[d.atmosphere.requests.length]=h},addCallback:function(h){-1===d.inArray(h,d.atmosphere.callbacks)&&d.atmosphere.callbacks.push(h)},removeCallback:function(h){h=d.inArray(h,d.atmosphere.callbacks);-1!==h&&d.atmosphere.callbacks.splice(h,1)},unsubscribe:function(){if(0<d.atmosphere.requests.length)for(var h=
[].concat(d.atmosphere.requests),k=0;k<h.length;k++){var g=h[k];g.close();clearTimeout(g.response.request.id)}d.atmosphere.requests=[];d.atmosphere.callbacks=[]},unsubscribeUrl:function(h){var k=-1;if(0<d.atmosphere.requests.length)for(var g=0;g<d.atmosphere.requests.length;g++){var t=d.atmosphere.requests[g];if(t.getUrl()===h){t.close();clearTimeout(t.response.request.id);k=g;break}}0<=k&&d.atmosphere.requests.splice(k,1)},publish:function(h){"function"===typeof h.callback&&d.atmosphere.addCallback(h.callback);
h.transport="polling";h=new d.atmosphere.AtmosphereRequest(h);return d.atmosphere.requests[d.atmosphere.requests.length]=h},checkCORSSupport:function(){return d.browser.msie&&!window.XDomainRequest||d.browser.opera&&12>+d.browser.version.split(".")[0]||"KreaTVWebKit/531"===d.trim(navigator.userAgent).slice(0,16)||"kreatel"===d.trim(navigator.userAgent).slice(-7).toLowerCase()?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")?!0:!1},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},
guid:function(){return d.atmosphere.S4()+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+d.atmosphere.S4()+d.atmosphere.S4()},prepareURL:function(h){var k=d.now(),g=h.replace(/([?&])_=[^&]*/,"$1_="+k);return g+(g===h?(/\?/.test(h)?"&":"?")+"_="+k:"")},param:function(h){return d.param(h,d.ajaxSettings.traditional)},supportStorage:function(){var h=window.localStorage;if(h)try{return h.setItem("t","t"),h.removeItem("t"),window.StorageEvent&&!d.browser.msie&&
!(d.browser.mozilla&&"1"===d.browser.version.split(".")[0])}catch(k){}return!1},iterate:function(d,k){var g;k=k||0;(function O(){g=setTimeout(function(){!1!==d()&&O()},k)})();return function(){clearTimeout(g)}},log:function(d,k){if(window.console){var g=window.console[d];"function"===typeof g&&g.apply(window.console,k)}},warn:function(){d.atmosphere.log("warn",arguments)},info:function(){d.atmosphere.log("info",arguments)},debug:function(){d.atmosphere.log("debug",arguments)},error:function(){d.atmosphere.log("error",
arguments)},isBinary:function(d){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(d))}};(function(){var h,k;d.uaMatch=function(d){d=d.toLowerCase();d=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(d)||0>d.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];return{browser:d[1]||"",version:d[2]||"0"}};h=d.uaMatch(navigator.userAgent);
k={};h.browser&&(k[h.browser]=!0,k.version=h.version);k.chrome?k.webkit=!0:k.webkit&&(k.safari=!0);k.trident&&(k.msie=!0);d.browser=k;d.sub=function(){function g(d,h){return new g.fn.init(d,h)}d.extend(!0,g,this);g.superclass=this;g.fn=g.prototype=this();g.fn.constructor=g;g.sub=this.sub;g.fn.init=function(k,l){l&&l instanceof d&&!(l instanceof g)&&(l=g(l));return d.fn.init.call(this,k,l,h)};g.fn.init.prototype=g.fn;var h=g(document);return g}})();(function(d){function k(d){return'"'+d.replace(O,
function(d){var g=l[d];return"string"===typeof g?g:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"'}function g(d){return 10>d?"0"+d:d}function t(d,h){var l,M,q,m=h[d];q=typeof m;m&&"object"===typeof m&&"function"===typeof m.toJSON&&(m=m.toJSON(d),q=typeof m);switch(q){case "string":return k(m);case "number":return isFinite(m)?String(m):"null";case "boolean":return String(m);case "object":if(!m)return"null";switch(Object.prototype.toString.call(m)){case "[object Date]":return isFinite(m.valueOf())?
'"'+m.getUTCFullYear()+"-"+g(m.getUTCMonth()+1)+"-"+g(m.getUTCDate())+"T"+g(m.getUTCHours())+":"+g(m.getUTCMinutes())+":"+g(m.getUTCSeconds())+'Z"':"null";case "[object Array]":M=m.length;q=[];for(l=0;l<M;l++)q.push(t(l,m)||"null");return"["+q.join(",")+"]";default:q=[];for(l in m)Object.prototype.hasOwnProperty.call(m,l)&&(M=t(l,m))&&q.push(k(l)+":"+M);return"{"+q.join(",")+"}"}}}var O=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
l={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};d.stringifyJSON=function(d){return window.JSON&&window.JSON.stringify?window.JSON.stringify(d):t("",{"":d})}})(d)});